<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify √úr√ºn SEO & Fiyat G√ºncelleyici v2</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f8f9fa; --border: #dee2e6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #333; margin: 0; padding: 40px; }
        .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h1 { color: var(--primary); margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        
        /* Input Alanƒ± */
        .input-group { display: flex; gap: 15px; margin-bottom: 30px; }
        input[type="text"] { flex: 1; padding: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; }
        button { padding: 15px 30px; background: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .btn-success { background-color: var(--accent); width: 100%; margin-top: 20px; font-size: 18px; }

        /* Pagination Kontrolleri */
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: #f1f3f5; border-radius: 8px; }
        .page-btn { padding: 8px 16px; background: #fff; border: 1px solid var(--border); color: var(--primary); border-radius: 4px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Tablo */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 15px; }
        th { text-align: left; padding: 15px; background: #f1f3f5; color: var(--primary); font-weight: 600; border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        img.thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Utility */
        .hidden { display: none; }
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-error { background: #f8d7da; color: #721c24; }
        .price-change { display: flex; flex-direction: column; gap: 4px; }
        .old-val { text-decoration: line-through; color: #999; font-size: 0.9em; }
        .new-val { color: var(--accent); font-weight: bold; }
        .loading-overlay { text-align: center; padding: 40px; color: #666; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõçÔ∏è Shopify Koleksiyon D√ºzenleyici</h1>

    <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
        ‚ö†Ô∏è <strong>Ayarlar:</strong> Kod i√ßindeki Webhook URL'lerini kontrol etmeyi unutmayƒ±n.
    </div>

    <div class="input-section">
        <div class="input-group">
            <input type="text" id="collectionUrl" placeholder="√ñrn: https://magazam.com/collections/yeni-sezon" />
            <button id="btnFetch" onclick="fetchProducts()">√úr√ºnleri Getir</button>
        </div>
    </div>

    <div id="loading" class="loading-overlay hidden">
        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
        <span id="loadingText">ƒ∞≈üleniyor...</span>
    </div>

    <div id="selectionSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>√úr√ºn Se√ßimi</h2>
            <span id="countDisplay" style="color: #666; font-weight: bold;">0 √ºr√ºn se√ßildi</span>
        </div>

        <div class="pagination-controls">
            <button class="page-btn" onclick="changePage(-1)">¬´ √ñnceki</button>
            <span id="pageInfo">Sayfa 1 / 1</span>
            <button class="page-btn" onclick="changePage(1)">Sonraki ¬ª</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="50"><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                    <th width="100">G√∂rsel</th>
                    <th>√úr√ºn Adƒ±</th>
                    <th>Mevcut Fiyat</th>
                </tr>
            </thead>
            <tbody id="productTable"></tbody>
        </table>
        
        <button class="btn-success" onclick="processSelected()">SE√áƒ∞LENLERƒ∞ G√ñNDER (SEO + Fƒ∞YAT)</button>
    </div>

    <div id="resultSection" class="hidden">
        <h2>‚úÖ ƒ∞≈ülem Raporu</h2>
        <table>
            <thead>
                <tr>
                    <th>Durum</th>
                    <th>G√∂rsel</th>
                    <th>√úr√ºn Adƒ± (Eski ‚ûî Yeni)</th>
                    <th>Fiyat (Eski ‚ûî Yeni)</th>
                    <th>Yeni A√ßƒ±klama (√ñzet)</th>
                </tr>
            </thead>
            <tbody id="resultTable"></tbody>
        </table>
        <button onclick="location.reload()" style="margin-top:20px;">Yeni ƒ∞≈ülem Yap</button>
    </div>
</div>

<script>
    // --- AYARLAR ---
    // n8n'deki Webhook URL'lerini buraya yapƒ±≈ütƒ±rƒ±n:
    const GET_PRODUCTS_WEBHOOK_URL = "https://dtt1z7t3.rcsrv.com/webhook/get-products"; 
    const PROCESS_PRODUCTS_WEBHOOK_URL = "https://dtt1z7t3.rcsrv.com/webhook/process-products"; 
    // ---------------

    let allProducts = [];      // API'den gelen t√ºm √ºr√ºnler
    let selectedIds = new Set(); // Se√ßili √ºr√ºnlerin ID'lerini tutar
    
    // Pagination Deƒüi≈ükenleri
    let currentPage = 1;
    const itemsPerPage = 10; 

    function showLoading(show, text="Y√ºkleniyor...") {
        const el = document.getElementById('loading');
        document.getElementById('loadingText').innerText = text;
        if(show) {
            el.classList.remove('hidden');
            document.getElementById('selectionSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
        } else {
            el.classList.add('hidden');
        }
    }

    async function fetchProducts() {
        const url = document.getElementById('collectionUrl').value;
        if(!url) return alert("URL giriniz");
        
        showLoading(true, "Shopify'dan √ºr√ºnler √ßekiliyor...");
        selectedIds.clear(); // Yeni aramada se√ßimleri sƒ±fƒ±rla

        try {
            const resp = await fetch(GET_PRODUCTS_WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ collectionUrl: url })
            });
            const data = await resp.json();
            
            // Eƒüer n8n { products: [...] } yerine farklƒ± bir ≈üey d√∂nerse diye √∂nlem:
            allProducts = data.products || data || []; 
            
            if(allProducts.length === 0) {
                showLoading(false);
                return alert("√úr√ºn bulunamadƒ±!");
            }

            // Sayfalamayƒ± sƒ±fƒ±rla ve tabloyu √ßiz
            currentPage = 1;
            renderTable();
            showLoading(false);
            document.getElementById('selectionSection').classList.remove('hidden');
        } catch(e) {
            showLoading(false);
            alert("Hata: " + e.message);
        }
    }

    // Tabloyu √áiz (Sadece o sayfadaki √ºr√ºnleri g√∂sterir)
    function renderTable() {
        const tbody = document.getElementById('productTable');
        tbody.innerHTML = '';

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = allProducts.slice(start, end);

        // Sayfa Bilgisini G√ºncelle
        const totalPages = Math.ceil(allProducts.length / itemsPerPage);
        document.getElementById('pageInfo').innerText = `Sayfa ${currentPage} / ${totalPages} (Toplam: ${allProducts.length})`;

        pageItems.forEach(p => {
            // Checkbox durumunu hatƒ±rla
            const isChecked = selectedIds.has(String(p.id)) ? 'checked' : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="p-check" value="${p.id}" ${isChecked} onchange="toggleSingle(this)"></td>
                <td><img src="${p.imageUrl}" class="thumb" onerror="this.src='https://via.placeholder.com/70'"></td>
                <td>${p.title}</td>
                <td>${p.price} TL</td>
            `;
            tbody.appendChild(tr);
        });

        // "T√ºm√ºn√º Se√ß" kutusunu sayfaya g√∂re g√ºncelle
        // (Opsiyonel: Burada sadece g√∂rsel olarak unchecked yapƒ±yoruz, mantƒ±k karma≈üƒ±kla≈ümasƒ±n diye)
        document.getElementById('selectAll').checked = false;
        
        updateCount();
    }

    // Sayfa Deƒüi≈ütirme
    function changePage(direction) {
        const totalPages = Math.ceil(allProducts.length / itemsPerPage);
        const newPage = currentPage + direction;

        if (newPage > 0 && newPage <= totalPages) {
            currentPage = newPage;
            renderTable();
        }
    }

    // Tekil Se√ßim Mantƒ±ƒüƒ±
    function toggleSingle(checkbox) {
        if (checkbox.checked) {
            selectedIds.add(checkbox.value);
        } else {
            selectedIds.delete(checkbox.value);
        }
        updateCount();
    }

    // T√ºm√ºn√º Se√ß (Sadece o sayfadakileri veya hepsini se√ßebilir, burada HEPSƒ∞Nƒ∞ se√ßtiriyoruz)
    function toggleAll() {
        const checked = document.getElementById('selectAll').checked;
        
        // Mevcut sayfadaki √ºr√ºnlerin checkboxlarƒ±nƒ± g√ºncelle
        document.querySelectorAll('.p-check').forEach(cb => cb.checked = checked);

        // Veri setini g√ºncelle
        if (checked) {
            // Hepsini sete ekle
            allProducts.forEach(p => selectedIds.add(String(p.id)));
        } else {
            // Hepsini setten √ßƒ±kar
            selectedIds.clear();
        }
        updateCount();
    }

    function updateCount() {
        document.getElementById('countDisplay').innerText = selectedIds.size + " √ºr√ºn se√ßildi";
    }

    async function processSelected() {
        if(selectedIds.size === 0) return alert("Se√ßim yapmadƒ±nƒ±z.");

        // Se√ßilen ID'lere g√∂re √ºr√ºn objelerini bul
        const productsToSend = allProducts.filter(p => selectedIds.has(String(p.id)));
        const payload = { products: productsToSend };
        
        showLoading(true, `Se√ßilen ${productsToSend.length} √ºr√ºn i≈üleniyor... Bu i≈ülem zaman alabilir.`);

        try {
            const resp = await fetch(PROCESS_PRODUCTS_WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await resp.json();
            
            console.log("Gelen Sonu√ß:", data); // Hata ayƒ±klama i√ßin konsola yazdƒ±rƒ±yoruz

            renderResults(data.results || []);
            showLoading(false);
            document.getElementById('resultSection').classList.remove('hidden');
        } catch(e) {
            showLoading(false);
            alert("ƒ∞≈ülem hatasƒ±: " + e.message);
        }
    }

    // Sonu√ß Tablosu (Undefined Hatasƒ± D√ºzeltildi)
    function renderResults(results) {
        const tbody = document.getElementById('resultTable');
        
        if (!results || results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Sonu√ß d√∂nmedi.</td></tr>';
            return;
        }

        tbody.innerHTML = results.map(r => {
            // ID e≈üle≈ütirmesini string'e √ßevirerek yapƒ±yoruz (Number/String hatasƒ±nƒ± √∂nler)
            const p = allProducts.find(x => String(x.id) === String(r.id)) || {};
            
            const isErr = r.status !== 'updated'; // status: error veya updated
            
            // Eƒüer deƒüerler undefined gelirse tire (-) koy
            const oldTitle = r.old_title || (p.title || '-');
            const newTitle = r.new_title || r.error_message || '-';
            const oldPrice = r.old_price ? r.old_price + ' TL' : '-';
            const newPrice = r.new_price ? r.new_price + ' TL' : '-';
            const desc = r.new_description ? r.new_description.substring(0, 80) + '...' : '-';

            return `
            <tr>
                <td><span class="badge ${isErr ? 'badge-error' : 'badge-success'}">${isErr ? 'HATA' : 'G√úNCELLENDƒ∞'}</span></td>
                <td><img src="${p.imageUrl || ''}" class="thumb" onerror="this.style.display='none'"></td>
                <td>
                    <div class="price-change">
                        <span class="old-val">${oldTitle}</span>
                        <span class="new-val">${newTitle}</span>
                    </div>
                </td>
                <td>
                    <div class="price-change">
                        <span class="old-val">${oldPrice}</span>
                        <span class="new-val">${newPrice}</span>
                    </div>
                </td>
                <td style="font-size:12px; color:#666;">${desc}</td>
            </tr>
            `;
        }).join('');
    }
</script>
</body>
</html>