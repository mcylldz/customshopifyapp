<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Shopify Manager</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary: #0071e3;
            --primary-hover: #0077ed;
            --success: #34c759;
            --warning: #ff9f0a;
            --danger: #ff3b30;
            --bg-gradient-start: #f5f5f7;
            --bg-gradient-end: #e8e8ed;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --border: #d2d2d7;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 12px 32px rgba(0, 0, 0, 0.12);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #0071e3 0%, #00a3ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-sub);
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-main);
        }

        .tab-btn:hover {
            background: rgba(0, 113, 227, 0.1);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"],
        select {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
            background: white;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: var(--danger);
        }

        button.success {
            background: var(--success);
        }

        button.secondary {
            background: transparent;
            color: var(--text-main);
            border: 2px solid var(--border);
        }

        .grid-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9fb;
            border-radius: 10px;
        }

        .img-item {
            position: relative;
            aspect-ratio: 2/3;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .img-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .img-item.selected {
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .img-item:hover {
            filter: brightness(0.95);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f1f3f5;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            min-width: 250px;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #eee;
            color: #666;
        }

        .status-processing {
            background: #fff3e0;
            color: #e65100;
        }

        .status-done {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        .wp-product-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .wp-product-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .wp-product-images img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .size-stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .size-item {
            background: #f9f9fb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .size-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .size-stock {
            color: var(--success);
            font-size: 14px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Unified Shopify Manager</h1>
            <p>AI Virtual Try-On ‚Ä¢ SEO Updater ‚Ä¢ WordPress Scraper</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(0)">ü§ñ Virtual Try-On</button>
            <button class="tab-btn" onclick="switchTab(1)">üìù SEO & Price</button>
            <button class="tab-btn" onclick="switchTab(2)">üõçÔ∏è WP Scraper</button>
        </div>

        <!-- TAB 1: VTON -->
        <div id="tab-0" class="tab-content active">
            <div class="grid-2-col">
                <div class="card">
                    <h2>Store A (Models)</h2>
                    <div class="input-group">
                        <input type="text" id="vton-url-a" placeholder="Shopify Product URL">
                        <button onclick="vtonApp.fetchImages('A')">Fetch</button>
                    </div>
                    <div id="vton-grid-a" class="image-grid"></div>
                </div>

                <div class="card">
                    <h2>Store B (Garments)</h2>
                    <div class="input-group">
                        <input type="text" id="vton-url-b" placeholder="Shopify Product URL">
                        <button onclick="vtonApp.fetchImages('B')">Fetch</button>
                    </div>
                    <div id="vton-grid-b" class="image-grid"></div>
                </div>
            </div>

            <div class="card">
                <h2>Match Pairs</h2>
                <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
                    <select id="vton-sel-a">
                        <option>Select Model...</option>
                    </select>
                    <select id="vton-sel-b">
                        <option>Select Garment...</option>
                    </select>
                    <select id="vton-type">
                        <option value="DRESS">Dress</option>
                        <option value="TOP">Top</option>
                        <option value="JACKET">Jacket</option>
                        <option value="BLOUSE">Blouse</option>
                        <option value="FULL_BODY_SET">Full Body Set</option>
                        <option value="BOTTOMS">Bottoms</option>
                        <option value="SKIRTS">Skirts</option>
                    </select>
                    <input type="text" id="fabric-info" placeholder="Fabric info (optional)" style="min-width:200px;">
                </div>
                <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap: wrap;">
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="radio" name="vton-mode" value="regular" checked>
                        <span>Regular VTON</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="radio" name="vton-mode" value="ghost">
                        <span>üëª Ghost Mode</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="radio" name="vton-mode" value="fabric">
                        <span>üßµ Fabric Mode</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="radio" name="vton-mode" value="sizechart">
                        <span>üìè Size Chart</span>
                    </label>
                    <button onclick="vtonApp.addPair()">Add Pair</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Garment</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="vton-pairs"></tbody>
                </table>
                <button style="margin-top:20px; width:100%;" class="success" onclick="vtonApp.runBatch()">Run AI
                    Batch</button>
            </div>

            <div class="card">
                <h2>Results</h2>
                <div id="vton-results"></div>
            </div>
        </div>

        <!-- TAB 2: SEO -->
        <div id="tab-1" class="tab-content">
            <div class="card">
                <h2>Collection SEO & Price Updater</h2>
                <div class="input-group">
                    <input type="text" id="seo-collection-url" placeholder="Collection URL">
                    <button onclick="seoApp.fetchProducts()">Get Products</button>
                </div>
                <table id="seo-table-wrapper" class="hidden">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="seo-select-all" onchange="seoApp.toggleAll()"></th>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody id="seo-products"></tbody>
                </table>
                <button class="success hidden" id="seo-process-btn" onclick="seoApp.processSelected()"
                    style="width:100%; margin-top:20px;">Process Selected</button>
            </div>

            <div id="seo-results" class="card hidden">
                <h2>Processing Results</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody id="seo-results-body"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3: WP Scraper -->
        <div id="tab-2" class="tab-content">
            <div class="card">
                <h2>WordPress Product Scraper</h2>
                <p style="color:var(--text-sub); margin-bottom:15px;">Enter WordPress product URL to extract details</p>
                <div class="input-group">
                    <input type="text" id="wp-url" placeholder="https://viyamoda.com/urun-179033"
                        value="https://viyamoda.com/urun-179033">
                    <button onclick="wpApp.scrapeProduct()">Scrape</button>
                </div>
                <div id="wp-result"></div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <!-- Import API Configuration -->
    <script src="config.js"></script> <!-- Local only (gitignored) -->
    <script src="runtime-config.js"></script> <!-- Netlify-safe wrapper -->

    <!-- Import Internal VTON System -->
    <script src="vton-internal.js"></script>

    <!-- Import Ghost Mode VTON -->
    <script src="vton-ghost.js"></script>

    <!-- Import Fabric Mode -->
    <script src="vton-fabric.js"></script>

    <!-- Import Size Chart Mode -->
    <script src="vton-sizechart.js"></script>

    <!-- Import Shopify Upload -->
    <script src="shopify-upload.js"></script>

    <!-- Import Product Builder -->
    <script src="product-builder.js"></script>
    <script src="google-sheets-logger.js"></script>

    <script>
        // CONFIG now loaded from runtime-config.js (which wraps config.js in local mode)
        const CONFIG = typeof API_CONFIG !== 'undefined' ? {
            // N8N Webhooks
            VTON_SUBMIT: API_CONFIG.N8N.WEBHOOKS.VTON_SUBMIT,
            VTON_STATUS: API_CONFIG.N8N.WEBHOOKS.VTON_STATUS,
            VTON_GHOST: API_CONFIG.N8N.WEBHOOKS.VTON_GHOST,
            REPLACE_IMG: API_CONFIG.N8N.WEBHOOKS.REPLACE_IMAGE,
            SEO_GET: API_CONFIG.N8N.WEBHOOKS.SEO_GET_PRODUCTS,
            SEO_PROCESS: API_CONFIG.N8N.WEBHOOKS.SEO_PROCESS,
            CORS_PROXY: API_CONFIG.SETTINGS.CORS_PROXY,

            // API Keys (now accessible)
            SHOPIFY: API_CONFIG.SHOPIFY,
            GOOGLE_SHEETS: API_CONFIG.GOOGLE_SHEETS,
            FAL_AI: API_CONFIG.FAL_AI,
            OPENAI: API_CONFIG.OPENAI
        } : {
            // Fallback if config.js is not loaded
            VTON_SUBMIT: "https://dtt1z7t3.rcsrv.com/webhook/vton-submit",
            VTON_STATUS: "https://dtt1z7t3.rcsrv.com/webhook/vton-status",
            VTON_GHOST: "https://dtt1z7t3.rcsrv.com/webhook/ghost-vton",
            REPLACE_IMG: "https://dtt1z7t3.rcsrv.com/webhook/replace-image",
            SEO_GET: "https://dtt1z7t3.rcsrv.com/webhook/get-products",
            SEO_PROCESS: "https://dtt1z7t3.rcsrv.com/webhook/process-products",
            CORS_PROXY: "https://api.allorigins.win/raw?url="
        };

        function switchTab(index) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        const vtonApp = {
            storeA: { images: [], productId: null },
            storeB: { images: [], productId: null },
            pairs: [],

            init() {
                // Add demo test result for upload testing
                const demoMode = false; // Set to false to disable
                if (demoMode) {
                    this.pairs.push({
                        id: 'demo-test-' + Date.now(),
                        modelUrl: 'DEMO_MODE',
                        garmentUrl: 'https://cdn.shopify.com/s/files/1/0687/9959/4561/files/demo-garment.jpg',
                        type: 'DRESS',
                        fabricInfo: '',
                        mode: 'regular',
                        status: 'done',
                        resultUrl: 'https://v3b.fal.media/files/b/0a853d88/5FcQyg5_1V6QRnjXqC0Fd.png',
                        productId: 7719480262721 // Your Store B product ID
                    });

                    setTimeout(() => {
                        this.renderResults();
                        showToast('‚úÖ Demo result loaded - Test upload without using tokens!', 'success');
                    }, 500);
                }
            },

            parseShopifyUrl(url) {
                try {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    const urlObj = new URL(url);
                    const parts = urlObj.pathname.split('/');
                    const idx = parts.indexOf('products');
                    if (idx === -1) return null;
                    return { domain: urlObj.hostname, handle: parts[idx + 1] };
                } catch { return null; }
            },

            async fetchImages(store) {
                const inputId = store === 'A' ? 'vton-url-a' : 'vton-url-b';
                const url = document.getElementById(inputId).value.trim();
                const parsed = this.parseShopifyUrl(url);
                if (!parsed) return showToast('Invalid URL', 'error');

                try {
                    const apiUrl = `https://${parsed.domain}/products/${parsed.handle}.json`;
                    const res = await fetch(apiUrl);
                    const data = await res.json();
                    const images = data.product.images.map(img => ({ src: img.src, id: img.id }));

                    if (store === 'A') this.storeA = { images, productId: data.product.id };
                    else this.storeB = { images, productId: data.product.id };

                    this.renderGrid(store);
                    this.updateDropdowns();
                    showToast(`Fetched ${images.length} images`);
                } catch (e) {
                    showToast('Fetch failed: ' + e.message, 'error');
                }
            },

            renderGrid(store) {
                const data = store === 'A' ? this.storeA : this.storeB;
                const grid = document.getElementById(`vton-grid-${store.toLowerCase()}`);
                grid.innerHTML = data.images.map(img =>
                    `<div class="img-item"><img src="${img.src}" loading="lazy"></div>`
                ).join('');
            },

            updateDropdowns() {
                const populate = (id, images) => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '<option value="">Select...</option>' +
                        images.map((img, i) => `<option value="${img.src}">Image ${i + 1}</option>`).join('');
                };
                populate('vton-sel-a', this.storeA.images);
                populate('vton-sel-b', this.storeB.images);
            },

            addPair() {
                const modelUrl = document.getElementById('vton-sel-a').value;
                const garmentUrl = document.getElementById('vton-sel-b').value;
                const type = document.getElementById('vton-type').value;
                const fabricInfo = document.getElementById('fabric-info').value.trim();

                // Get selected mode from radio buttons
                const modeRadio = document.querySelector('input[name="vton-mode"]:checked');
                const mode = modeRadio ? modeRadio.value : 'regular';

                // Validation based on mode
                if (mode === 'ghost' || mode === 'fabric' || mode === 'sizechart') {
                    // Ghost, Fabric and Size Chart modes only need garment
                    if (!garmentUrl) return showToast(`Select garment for ${mode} mode`, 'error');
                } else {
                    // Regular VTON needs both
                    if (!modelUrl || !garmentUrl) return showToast('Select both images', 'error');
                }

                this.pairs.push({
                    id: Date.now().toString(),
                    modelUrl: (mode === 'ghost' || mode === 'fabric') ? mode.toUpperCase() + '_MODE' : modelUrl,
                    garmentUrl,
                    type,
                    fabricInfo,
                    mode,  // 'regular', 'ghost', or 'fabric'
                    status: 'pending',
                    resultUrl: null,
                    productId: this.storeB.productId
                });
                this.renderPairs();
            },

            renderPairs() {
                const tbody = document.getElementById('vton-pairs');
                tbody.innerHTML = this.pairs.map(p => `
                    <tr>
                        <td><img src="${p.modelUrl}" class="thumb"></td>
                        <td><img src="${p.garmentUrl}" class="thumb"></td>
                        <td>${p.type}</td>
                        <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                        <td><button class="danger" onclick="vtonApp.removePair('${p.id}')">Remove</button></td>
                    </tr>
                `).join('');
            },

            removePair(id) {
                this.pairs = this.pairs.filter(p => p.id !== id);
                this.renderPairs();
            },

            async runBatch() {
                const pending = this.pairs.filter(p => p.status === 'pending');
                if (!pending.length) return showToast('No pending pairs', 'error');

                for (const pair of pending) {
                    await this.processPair(pair);
                }
            },

            async processPair(pair) {
                const idx = this.pairs.findIndex(p => p.id === pair.id);
                this.pairs[idx].status = 'processing';
                this.renderPairs();

                try {
                    let resultUrl;

                    // Check mode
                    if (pair.mode === 'sizechart') {
                        // Size Chart Mode: Turkish size chart generation
                        showToast('Converting size chart to Turkish...', 'success');

                        const sizeChartResult = await window.VTON.processSizeChartMode(
                            pair.garmentUrl
                        );

                        resultUrl = sizeChartResult.output_image;

                    } else if (pair.mode === 'fabric') {
                        // Fabric Mode: High-res texture generation
                        showToast('Generating fabric texture...', 'success');

                        const fabricResult = await window.VTON.processFabricMode(
                            pair.garmentUrl,
                            pair.fabricInfo
                        );

                        resultUrl = fabricResult.output_image;

                    } else if (pair.mode === 'ghost') {
                        // Ghost mode: only garment, no model
                        showToast('Running ghost mode...', 'success');

                        const ghostResult = await window.VTON.processGhostMode(
                            pair.garmentUrl,
                            pair.type,
                            'Product'
                        );

                        resultUrl = ghostResult.output_image;

                    } else {
                        // Regular VTON mode
                        showToast('Analyzing images with OpenAI...', 'success');

                        const jobResult = await window.VTON.processVTONPair(
                            pair.modelUrl,
                            pair.garmentUrl,
                            pair.type,
                            'Product'
                        );

                        showToast('VTON job submitted, polling for result...', 'success');

                        resultUrl = await window.VTON.pollVTONResult(jobResult.request_id);
                    }

                    this.pairs[idx].status = 'done';
                    this.pairs[idx].resultUrl = resultUrl;
                    this.renderPairs();
                    this.renderResults();
                    showToast('Processing completed successfully!', 'success');

                } catch (e) {
                    console.error('Processing Error:', e);
                    this.pairs[idx].status = 'error';
                    this.pairs[idx].status = 'error';
                    this.renderPairs();
                    showToast('Processing failed: ' + e.message, 'error');
                }
            },

            async uploadWithOptions(pairId) {
                const pair = this.pairs.find(p => p.id === pairId);
                if (!pair || !pair.resultUrl) return showToast('No result to upload', 'error');

                // Get upload mode from radio buttons
                const modeRadio = document.querySelector(`input[name="upload-mode-${pairId}"]:checked`);
                const replaceMode = modeRadio ? modeRadio.value === 'replace' : true;

                // Get position from input
                const positionInput = document.getElementById(`upload-pos-${pairId}`);
                const position = positionInput ? parseInt(positionInput.value) : 1;

                if (!position || position < 1 || position > 10) {
                    return showToast('Position must be between 1-10', 'error');
                }

                try {
                    showToast('Uploading to Shopify...', 'success');

                    // If replace mode, get image at position to delete
                    let oldImageId = null;
                    if (replaceMode && pair.productId) {
                        const images = await window.ShopifyUpload.getProductImages(pair.productId);
                        const imageAtPos = images.find(img => img.position === position);
                        oldImageId = imageAtPos?.id;

                        if (!oldImageId) {
                            console.warn(`No image found at position ${position}, will insert instead`);
                        }
                    }

                    const result = await window.ShopifyUpload.uploadToShopify(
                        pair.productId,
                        pair.resultUrl,
                        position,
                        replaceMode,
                        oldImageId
                    );

                    showToast(`‚úÖ Uploaded to Shopify at position ${result.position}!`, 'success');
                    console.log('Upload result:', result);

                } catch (e) {
                    console.error('Shopify Upload Error:', e);
                    showToast('Upload failed: ' + e.message, 'error');
                }
            },

            renderResults() {
                const container = document.getElementById('vton-results');
                const done = this.pairs.filter(p => p.status === 'done' && p.resultUrl);

                if (done.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:var(--text-sub); padding:40px;">No results yet. Run AI Batch to see results here.</p>';
                    return;
                }

                container.innerHTML = `
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:20px; margin-top:20px;">
                        ${done.map(p => {
                    // Get mode icon and label
                    let modeIcon = 'üëî';
                    let modeLabel = 'VTON Mode';
                    if (p.mode === 'ghost') {
                        modeIcon = 'üëª';
                        modeLabel = 'Ghost Mode';
                    } else if (p.mode === 'fabric') {
                        modeIcon = 'üßµ';
                        modeLabel = 'Fabric Mode';
                    } else if (p.mode === 'sizechart') {
                        modeIcon = 'üìè';
                        modeLabel = 'Size Chart';
                    }

                    return `
                            <div style="background:white; border-radius:12px; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column;">
                                <!-- Image Preview -->
                                <div style="position:relative; width:100%; aspect-ratio:9/16; overflow:hidden; background:#f5f5f7; cursor:pointer;" onclick="window.open('${p.resultUrl}')">
                                    <img src="${p.resultUrl}" style="width:100%; height:100%; object-fit:cover;" loading="lazy">
                                    <div style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); color:white; padding:5px 10px; border-radius:6px; font-size:12px; font-weight:500;">
                                        ${modeIcon} ${modeLabel}
                                    </div>
                                </div>
                                
                                <!-- Info & Actions -->
                                <div style="padding:15px;">
                                    <div style="font-size:13px; color:var(--text-sub); margin-bottom:10px;">
                                        ${p.type}${p.fabricInfo ? ' ‚Ä¢ ' + p.fabricInfo : ''}
                                    </div>
                                    
                                    <!-- Shopify Upload Section -->
                                    <div style="background:#f9f9fb; padding:12px; border-radius:8px; margin-bottom:10px;">
                                        <div style="font-size:12px; font-weight:600; margin-bottom:8px; color:#333;">üì§ Upload to Shopify</div>
                                        
                                        <div style="display:flex; gap:10px; margin-bottom:8px; font-size:12px;">
                                            <label style="display:flex; align-items:center gap:4px; cursor:pointer;">
                                                <input type="radio" name="upload-mode-${p.id}" value="replace" checked>
                                                <span>üîÑ Replace</span>
                                            </label>
                                            <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                                                <input type="radio" name="upload-mode-${p.id}" value="insert">
                                                <span>‚ûï Insert</span>
                                            </label>
                                        </div>
                                        
                                        <div style="display:flex; gap:8px; align-items:center;">
                                            <input type="number" id="upload-pos-${p.id}" min="1" max="10" value="1" style="width:50px; padding:6px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
                                            <button class="success" onclick="vtonApp.uploadWithOptions('${p.id}')" style="flex:1; padding:8px; font-size:12px;">Upload</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div style="display:flex; gap:8px;">
                                        <button class="secondary" onclick="window.open('${p.resultUrl}')" style="flex:1; padding:8px; font-size:12px;">üîó Open</button>
                                        <button class="secondary" onclick="navigator.clipboard.writeText('${p.resultUrl}')" style="flex:1; padding:8px; font-size:12px;">üìã Copy URL</button>
                                    </div>
                                </div>
                            </div>
                            `;
                }).join('')}
                    </div>
                `;
            }
        };

        const seoApp = {
            products: [],
            selected: new Set(),

            async fetchProducts() {
                const url = document.getElementById('seo-collection-url').value.trim();
                if (!url) return showToast('Enter collection URL', 'error');

                try {
                    const res = await fetch(CONFIG.SEO_GET, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ collectionUrl: url })
                    });
                    const data = await res.json();
                    this.products = data.products || [];
                    this.renderProducts();
                    document.getElementById('seo-table-wrapper').classList.remove('hidden');
                    document.getElementById('seo-process-btn').classList.remove('hidden');
                    showToast(`Loaded ${this.products.length} products`);
                } catch (e) {
                    showToast('Failed to fetch: ' + e.message, 'error');
                }
            },

            renderProducts() {
                const tbody = document.getElementById('seo-products');
                tbody.innerHTML = this.products.map(p => `
                    <tr>
                        <td><input type="checkbox" value="${p.id}" onchange="seoApp.toggleProduct(this)"></td>
                        <td><img src="${p.imageUrl}" class="thumb"></td>
                        <td>${p.title}</td>
                        <td>${p.price} TL</td>
                    </tr>
                `).join('');
            },

            toggleProduct(cb) {
                if (cb.checked) this.selected.add(cb.value);
                else this.selected.delete(cb.value);
            },

            toggleAll() {
                const checked = document.getElementById('seo-select-all').checked;
                document.querySelectorAll('#seo-products input[type="checkbox"]').forEach(cb => {
                    cb.checked = checked;
                    if (checked) this.selected.add(cb.value);
                    else this.selected.delete(cb.value);
                });
            },

            async processSelected() {
                if (!this.selected.size) return showToast('No products selected', 'error');

                const toProcess = this.products.filter(p => this.selected.has(String(p.id)));

                try {
                    const res = await fetch(CONFIG.SEO_PROCESS, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ products: toProcess })
                    });
                    const data = await res.json();
                    this.renderResults(data.results || []);
                    document.getElementById('seo-results').classList.remove('hidden');
                    showToast('Processing complete!');
                } catch (e) {
                    showToast('Processing failed: ' + e.message, 'error');
                }
            },

            renderResults(results) {
                const tbody = document.getElementById('seo-results-body');
                tbody.innerHTML = results.map(r => {
                    const p = this.products.find(x => String(x.id) === String(r.id)) || {};
                    const isErr = r.status !== 'updated';
                    return `
                        <tr>
                            <td><span class="status-badge ${isErr ? 'status-error' : 'status-done'}">${isErr ? 'ERROR' : 'UPDATED'}</span></td>
                            <td><img src="${p.imageUrl}" class="thumb"></td>
                            <td>${r.new_title || r.old_title || '-'}</td>
                            <td>${r.new_price || r.old_price || '-'} TL</td>
                        </tr>
                    `;
                }).join('');
            }
        };

        // ===================================
        // PRODUCT BUILDER STATE (WP to Shopify)
        // ===================================
        const productBuilder = {
            step: 0, // 0=idle, 1=scraped, 2=model, 3=vton, 4=ai, 5=price, 6=review
            wpData: null,
            modelImages: [],
            vtonPairs: [],
            aiTitle: null,
            aiDescription: null,
            finalPrice: null,
            priceMultiplier: null,

            reset() {
                this.step = 0;
                this.wpData = null;
                this.modelImages = [];
                this.vtonPairs = [];
                this.aiTitle = null;
                this.aiDescription = null;
                this.finalPrice = null;
                this.priceMultiplier = null;
            }
        };

        // ===================================
        // WORDPRESS SCRAPER
        // ===================================
        const wpApp = {
            async scrapeProduct() {
                const url = document.getElementById('wp-url').value.trim();
                if (!url) return showToast('Enter WP URL', 'error');

                const productCode = url.split('/').pop().split('-').pop();

                try {
                    showToast('Scraping...');

                    // Use local proxy server (same as Shopify upload)
                    const proxyPayload = {
                        action: 'wp_scrape',
                        wp_url: url
                    };

                    const proxyRes = await fetch(API_BASE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxyPayload)
                    });

                    if (!proxyRes.ok) {
                        throw new Error(`Proxy returned ${proxyRes.status}`);
                    }

                    const html = await proxyRes.text();

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    const title = doc.querySelector('title')?.textContent.split('|')[0].trim() ||
                        doc.querySelector('h1')?.textContent.trim() || 'N/A';

                    // Try multiple methods to extract price
                    let price = 'N/A';

                    // Method 1: .product-price element
                    let priceEl = doc.querySelector('.product-price');
                    if (priceEl) {
                        price = priceEl.textContent.replace(/[^\d.,]/g, '').trim();
                    }

                    // Method 2: Try price meta tag
                    if (price === 'N/A' || !price) {
                        const priceMeta = doc.querySelector('meta[property="product:price:amount"]');
                        if (priceMeta) price = priceMeta.getAttribute('content');
                    }

                    // Method 3: Search HTML with regex for price pattern
                    if (price === 'N/A' || !price) {
                        const priceMatch = html.match(/product-price[^>]*>([^<]*[\d.,]+[^<]*)</i);
                        if (priceMatch) {
                            price = priceMatch[1].replace(/[^\d.,]/g, '').trim();
                        }
                    }

                    // Method 4: Look for price in structured data
                    if (price === 'N/A' || !price) {
                        const scriptTags = doc.querySelectorAll('script[type="application/ld+json"]');
                        for (const script of scriptTags) {
                            try {
                                const data = JSON.parse(script.textContent);
                                if (data.offers && data.offers.price) {
                                    price = data.offers.price;
                                    break;
                                } else if (data['@type'] === 'Product' && data.offers) {
                                    price = data.offers[0]?.price || data.offers.price;
                                    break;
                                }
                            } catch (e) { }
                        }
                    }

                    price = price || 'N/A';

                    // Parse Turkish price format (e.g., "1.119 TL" = 1119, "1.119,50 TL" = 1119.50)
                    if (price !== 'N/A') {
                        // Remove currency symbols and whitespace
                        let cleanPrice = typeof price === 'string' ? price.replace(/[^\d.,]/g, '').trim() : price.toString();

                        // Turkish format: dots are thousand separators, commas are decimal separators
                        // Check if there's a comma (decimal separator)
                        if (cleanPrice.includes(',') && cleanPrice.includes('.')) {
                            // Format: "1.119,50" -> remove dots, replace comma with dot
                            cleanPrice = cleanPrice.replace(/\./g, '').replace(',', '.');
                        } else if (cleanPrice.includes(',')) {
                            // Format: "119,50" -> just replace comma with dot
                            cleanPrice = cleanPrice.replace(',', '.');
                        } else if (cleanPrice.includes('.')) {
                            // Turkish sites use dot as thousand separator
                            // Check if it looks like a thousand separator
                            const parts = cleanPrice.split('.');

                            // If we have multiple dots OR the part after dot is 3 digits, it's thousands
                            if (parts.length > 2 || (parts.length === 2 && parts[1].length === 3)) {
                                // Remove all dots (they're thousand separators)
                                cleanPrice = cleanPrice.replace(/\./g, '');
                            }
                            // Otherwise keep dot as decimal (for prices like "9.99" from international sites)
                        }

                        price = parseFloat(cleanPrice);
                        console.log('Parsed price:', price, 'from:', typeof price === 'string' ? price : cleanPrice);
                    }

                    // Extract images using multiple methods
                    let images = [];

                    // Method 1: Thumbnail list (works for ViyaModa)
                    const thumbImages = Array.from(doc.querySelectorAll('.cz-thumblist-item img'));
                    images = thumbImages.map(img => img.getAttribute('src')).filter(Boolean);

                    // Method 2: Product gallery images
                    if (images.length === 0) {
                        const galleryImages = Array.from(doc.querySelectorAll('.product-gallery img, .product__image'));
                        images = galleryImages.map(img => img.getAttribute('src')).filter(Boolean);
                    }

                    // Method 3: Main product image
                    if (images.length === 0) {
                        const mainImageEl = doc.querySelector('#main-image, .product-image img, [data-zoom-image]');
                        if (mainImageEl) {
                            const src = mainImageEl.getAttribute('src') || mainImageEl.getAttribute('data-zoom-image');
                            if (src) images.push(src);
                        }
                    }

                    // Clean up image URLs (remove null/undefined and ensure absolute URLs)
                    images = images.filter(Boolean).map(src => {
                        if (src.startsWith('//')) return 'https:' + src;
                        if (src.startsWith('/')) {
                            const urlObj = new URL(url);
                            return urlObj.origin + src;
                        }
                        return src;
                    });

                    // Extract sizes with stock
                    const sizes = [];
                    doc.querySelectorAll('#product-size input.qwinputs').forEach(input => {
                        sizes.push({
                            size: input.value,
                            stock: parseInt(input.dataset.miktar) || 0
                        });
                    });

                    // Store in product builder state
                    productBuilder.wpData = {
                        productCode,
                        title,
                        price: typeof price === 'number' ? price : parseFloat(price.replace(',', '.')),
                        images,
                        sizes,
                        originalUrl: url
                    };
                    productBuilder.step = 1;

                    this.renderScrapedProduct();
                    showToast('‚úÖ Product scraped! Ready for product building');
                } catch (e) {
                    showToast('Scraping failed: ' + e.message, 'error');
                }
            },

            renderScrapedProduct() {
                const container = document.getElementById('wp-result');
                const data = productBuilder.wpData;

                container.innerHTML = `
                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow); margin-top:20px;">
                        <h3 style="margin:0 0 15px 0; color:#333;">‚úÖ Product Scraped Successfully</h3>
                        
                        <div style="display:grid; grid-template-columns:200px 1fr; gap:20px; margin-bottom:20px;">
                            <!-- Images -->
                            <div>
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">Product Images (${data.images.length})</h4>
                                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:5px;">
                                    ${data.images.slice(0, 4).map(img => `
                                        <img src="${img}" style="width:100%; aspect-ratio:1; object-fit:cover; border-radius:6px;">
                                    `).join('')}
                                </div>
                                ${data.images.length > 4 ? `<p style="margin:5px 0 0 0; font-size:11px; color:#999;">+${data.images.length - 4} more</p>` : ''}
                            </div>
                            
                            <!-- Product Info -->
                            <div>
                                <p style="margin:0 0 8px 0;"><strong>Product Code:</strong> ${data.productCode}</p>
                                <p style="margin:0 0 8px 0;"><strong>Title:</strong> ${data.title}</p>
                                <p style="margin:0 0 15px 0;"><strong>Price:</strong> ${data.price} TL</p>
                                
                                <h4 style="margin:0 0 8px 0; font-size:13px; color:#666;">Variants & Stock</h4>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    ${data.sizes.map(s => `
                                        <div style="padding:6px 12px; background:#f5f5f7; border-radius:6px; font-size:12px;">
                                            <strong>${s.size}</strong> - Stock: ${s.stock}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <button class="primary" onclick="productBuilderApp.startBuilding()" style="width:100%; padding:12px;">
                            üöÄ Start Building Product for Shopify
                        </button>
                    </div>
                `;
            },

            renderResult(data) {
                // Legacy method - redirect to new one
                productBuilder.wpData = data;
                productBuilder.step = 1;
                this.renderScrapedProduct();
                const html = `
                    <div class="wp-product-card">
                        <h3 style="margin-bottom:15px;">Product Code: ${data.productCode}</h3>
                        <p><strong>Title:</strong> ${data.title}</p>
                        <p><strong>Price:</strong> ${data.price}</p>
                        
                        <h4 style="margin-top:20px;">Product Images (${data.images.length})</h4>
                        <div class="wp-product-images">
                            ${data.images.map(img => `<img src="${img}" alt="Product">`).join('')}
                        </div>

                        <h4 style="margin-top:20px;">Sizes & Stock</h4>
                        <div class="size-stock-grid">
                            ${data.sizes.map(s => `
                                <div class="size-item">
                                    <div class="size-name">${s.size}</div>
                                    <div class="size-stock">Stock: ${s.stock}</div>
                                </div>
                            `).join('')}
                        </div>

                        <button onclick="wpApp.exportData()" style="margin-top:20px;">Export as JSON</button>
                    </div>
                `;
                document.getElementById('wp-result').innerHTML = html;
                this.currentData = data;
            },

            exportData() {
                const dataStr = JSON.stringify(this.currentData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `product-${this.currentData.productCode}.json`;
                a.click();
                showToast('Exported successfully!');
            }
        };

        // Initialize vtonApp on page load
        vtonApp.init();
    </script>
</body>

</html>